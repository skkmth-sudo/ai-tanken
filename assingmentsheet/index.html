<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ことば教室「あい先生」内容シート</title>

<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;600;700&family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">

<style>
  :root{ --w: 820px; }
  *{ box-sizing:border-box; }
  body{
    margin:0;
    background:#f6f7fb;
    font-family:"Zen Maru Gothic","M PLUS Rounded 1c","Yu Gothic",system-ui,sans-serif;
  }
  .app{ display:flex; gap:16px; padding:16px; }
  .sheet-wrap{ flex:1 1 auto; display:flex; justify-content:center; align-items:flex-start; }
  .sheet{
    position:relative;
    width:min(100%, var(--w));
    aspect-ratio:210/297;
    background:#fff;
    border-radius:16px;
    box-shadow:0 12px 32px rgba(15,23,42,.09);
    overflow:hidden;
  }
  .bg{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    object-fit:cover;
    pointer-events:none;
  }

  /* Week題名（中央・大きめ） */
  #L_week{
    position:absolute;
    left:0;
    right:0;
    top:17%;
    text-align:center;
    font-size:2.7rem;
    font-weight:700;
    letter-spacing:.02em;
    color:#1f2937;
    padding:.2rem 0;
    background:transparent;
  }

  /* ①②③ラベル */
  .label{
    position:absolute;
    padding:.35rem .7rem;
    font-weight:700;
    border-radius:12px;
    background:rgba(255,255,255,.85);
    border:2px dashed rgba(99,102,241,.22);
    font-size:0.95rem;
  }
  /* 白枠の少し上に配置（背景に合わせてチューニング） */
  #L_q1{ left:7%; top:22.3%; }
  #L_q2{ left:7%; top:46%; }
  #L_q3{ left:7%; top:70%; }

  /* 入力欄（白枠に重ねる） */
  .field{
    position:absolute;
    outline:none;
    border:none;
    background:transparent;
    color:#111827;
    padding:10px 14px;
    font-size:1rem;
    line-height:1.5;
    border-radius:18px;
  }
  .field:empty::before{
    content: attr(data-placeholder);
    color:#9ca3af;
  }

  /* ▼ここを背景に合わせてある（さらに微調整したくなったら top/height を少し動かす） */
  /* 右上の「なまえ」白枠 */
  #F_name{
    left:58.5%;
    top:12%;
    width:33.5%;
    height:6.3%;
  }
  /* 1段目・細長い白枠 */
  #F_box1{
    left:13%;
    top:26%;
    width:75%;
    height:7.3%;
  }
  /* 2段目・大きめ白枠 */
  #F_box2{
    left:13%;
    top:51%;
    width:75%;
    height:15.2%;
  }
  /* 3段目・大きめ白枠 */
  #F_box3{
    left:13%;
    top:74.3%;
    width:75%;
    height:15.5%;
  }
  
 

  /* 右パネル */
  .side{
    width:360px;
    flex:0 0 360px;
    background:#fff;
    border:1px solid #e5e7eb;
    border-radius:14px;
    padding:14px;
    box-shadow:0 12px 32px rgba(15,23,42,.06);
  }
  .side h2{ margin:6px 0 10px; font-size:18px; }
  .row{ display:flex; flex-direction:column; gap:6px; margin:10px 0; }
  .side input{
    border:1px solid #e5e7eb;
    border-radius:12px;
    padding:10px 12px;
    font-size:14px;
    outline:none;
    font-family:inherit;
  }
  .btns{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  button{
    padding:10px 12px;
    border-radius:12px;
    border:1px solid #e5e7eb;
    background:#fff;
    cursor:pointer;
    font-weight:700;
    font-family:inherit;
  }
  .primary{ background:#6366f1; color:#fff; border:none; }
  .ghost{ background:#fff; color:#111827; }
  small.muted{ color:#6b7280; line-height:1.6; }

  @media print{
    body{ background:#fff; }
    .app{ display:block; padding:0; }
    .side{ display:none !important; }
    .sheet{
      width:210mm;
      height:297mm;
      border-radius:0;
      box-shadow:none;
    }
    .label{ border:none !important; background:transparent !important; }
  }
</style>
</head>
<body>
<div class="app">
  <div class="sheet-wrap">
    <div class="sheet" id="sheet">
      <img class="bg" src="background-week1.png" alt="background" />

      <!-- Week題名 -->
      <div id="L_week">Week1　すきなものあつめ</div>

      <!-- ①②③見出し -->
      <div class="label" id="L_q1">① きみのすきなものをおしえてね</div>
      <div class="label" id="L_q2">② どこがすきかおしえてね</div>
      <div class="label" id="L_q3">③ あなたはてんこうせいです。じこしょうかいをしてみよう</div>

      <!-- 入力欄 -->
      <div id="F_name" class="field" contenteditable="true" data-placeholder="なまえ（ニックネームOK）"></div>
      <div id="F_box1" class="field" contenteditable="true" data-placeholder="①のこたえ"></div>
      <div id="F_box2" class="field" contenteditable="true" data-placeholder="②のこたえ"></div>
      <div id="F_box3" class="field" contenteditable="true" data-placeholder="③のこたえ"></div>
      </div>
  </div>

  <aside class="side">
    <h2>Week切り替え & CSV</h2>
    <div class="row">
      <label>Week番号</label>
      <div style="display:flex; gap:8px;">
        <input id="I_week" placeholder="例：1" style="width:120px;">
        <button class="ghost" id="dec">-1</button>
        <button class="ghost" id="inc">+1</button>
        <button class="primary" id="apply">反映</button>
      </div>
    </div>

    <div class="row">
      <label>CSV（ai_sensei_weeks.csv）</label>
      <div class="btns">
        <button class="ghost" id="reloadCsv">CSVを読み込む</button>
      </div>
      <small class="muted">
        index.html と同じフォルダに
        <b>ai_sensei_weeks.csv</b> を置いてください。<br>
        Excelで内容を変えて保存 → このボタンかページ再読み込みで反映されます。
      </small>
    </div>

    <div class="btns">
      <button class="primary" id="pdf">PDF出力</button>
      <button class="ghost" id="print">印刷</button>
    </div>
  </aside>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
  const $ = s => document.querySelector(s);
  const CSV_PATH = 'ai_sensei_weeks.csv';
  let WEEK_DB = {};

  // ダブルクォーテーションをきれいにするヘルパー
  const clean = (s = '') => {
    s = s.trim();
    if (s.startsWith('"') && s.endsWith('"') && s.length >= 2) {
      s = s.slice(1, -1);
    }
    return s.replace(/""/g, '"');
  };

  function parseCSV(text){
    if (text.charCodeAt(0) === 0xFEFF) {
      text = text.slice(1);
    }
    const lines = text.trim().split(/\r?\n/);
    if (!lines.length) return {};

    const header = lines[0].split(',').map(s => clean(s).toLowerCase());
    const wIdx  = header.indexOf('week');
    const tIdx  = header.indexOf('title');
    const q1Idx = header.indexOf('q1');
    const q2Idx = header.indexOf('q2');
    const q3Idx = header.indexOf('q3');

    const out = {};
    for (let i = 1; i < lines.length; i++){
      const line = lines[i];
      if (!line.trim()) continue;
      const cols = line.split(',').map(clean);
      const wk = (cols[wIdx] || '').replace(/[^0-9]/g,'');
      if (!wk) continue;
      out[wk] = {
        title: cols[tIdx]  || '',
        q1:    cols[q1Idx] || '',
        q2:    cols[q2Idx] || '',
        q3:    cols[q3Idx] || ''
      };
    }
    return out;
  }

  async function loadCsv(){
    try{
      const res = await fetch(CSV_PATH + '?t=' + Date.now());
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const text = await res.text();
      WEEK_DB = parseCSV(text);
      renderByWeek();
    }catch(e){
      alert('CSV読み込みエラー：' + e.message);
    }
  }

  const L_week = $('#L_week'), L_q1 = $('#L_q1'), L_q2 = $('#L_q2'), L_q3 = $('#L_q3');
  const I_week = $('#I_week');

  function renderByWeek(){
    const w = (I_week.value || '1').replace(/[^0-9]/g,'') || '1';
    const row = WEEK_DB[w] || { title:'', q1:'', q2:'', q3:'' };
    const title = row.title || '（題名未設定）';
    L_week.textContent = `Week${w}　${title}`;
    L_q1.textContent = row.q1 ? `① ${row.q1}` : '①';
    L_q2.textContent = row.q2 ? `② ${row.q2}` : '②';
    L_q3.textContent = row.q3 ? `③ ${row.q3}` : '③';
  }

  $('#pdf').addEventListener('click', async ()=>{
    const node = $('#sheet');
    const canvas = await html2canvas(node, { scale: 2, backgroundColor: null });
    const img = canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ orientation:'p', unit:'mm', format:'a4' });
    const W = pdf.internal.pageSize.getWidth();
    const H = pdf.internal.pageSize.getHeight();
    pdf.addImage(img, 'PNG', 0, 0, W, H);
    const w = (I_week.value || '1').replace(/[^0-9]/g,'') || '1';
    pdf.save(`ai_sensei_week${w}.pdf`);
  });

  $('#print').addEventListener('click', ()=> window.print());
  $('#apply').addEventListener('click', renderByWeek);
  $('#inc').addEventListener('click', ()=>{
    I_week.value = String((parseInt(I_week.value || '1') || 1) + 1);
    renderByWeek();
  });
  $('#dec').addEventListener('click', ()=>{
    I_week.value = String(Math.max(1,(parseInt(I_week.value || '1') || 1) - 1));
    renderByWeek();
  });
  $('#reloadCsv').addEventListener('click', ()=> loadCsv());

  I_week.value = '1';
  loadCsv();
</script>
</body>
</html>
